# 安卓信号测试软件技术实现方案

## 1. 项目结构设计

### 1.1 目录结构
```
SignalTestApp/
├── app/
│   ├── src/main/
│   │   ├── java/com/signal/test/
│   │   │   ├── activities/
│   │   │   │   ├── MainActivity.java      # 主界面
│   │   │   │   ├── CameraActivity.java     # 相机界面
│   │   │   │   └── HistoryActivity.java    # 历史记录界面
│   │   │   ├── fragments/
│   │   │   │   ├── SignalInfoFragment.java # 信号信息显示
│   │   │   │   └── MapFragment.java        # 地图显示（可选）
│   │   │   ├── services/
│   │   │   │   ├── SignalCollector.java    # 信号采集服务
│   │   │   │   └── LocationService.java    # 定位服务
│   │   │   ├── utils/
│   │   │   │   ├── NetworkUtils.java       # 网络工具类
│   │   │   │   ├── CameraUtils.java         # 相机工具类
│   │   │   │   └── StorageUtils.java        # 存储工具类
│   │   │   ├── models/
│   │   │   │   └── SignalData.java         # 信号数据模型
│   │   │   └── adapters/
│   │   │       └── HistoryAdapter.java      # 历史记录适配器
│   │   ├── res/
│   │   │   ├── layout/
│   │   │   ├── drawable/
│   │   │   └── values/
│   │   └── AndroidManifest.xml
│   └── build.gradle
└── build.gradle
```

### 1.2 数据模型

#### SignalData.java
```java
public class SignalData {
    private String operator;          // 运营商
    private String cgi;               // 小区CGI
    private int frequency;            // 频点
    private String band;              // 频段
    private int rssi;                 // 接收电平
    private String networkType;       // 网络类型
    private double latitude;          // 纬度
    private double longitude;         // 经度
    private String location;          // 位置描述
    private String timestamp;         // 时间戳
    private String photoPath;         // 照片路径
    
    // getters and setters
}
```

## 2. 核心功能实现方案

### 2.1 小区信息采集

#### 技术方案
- 使用`TelephonyManager`获取运营商信息和网络类型
- 使用`PhoneStateListener`监听信号强度变化
- 对于Android 10及以上版本，使用`TelephonyManager`的`getAllCellInfo()`方法获取小区信息
- 对于Android 9及以下版本，使用反射获取`CellIdentity`和`CellSignalStrength`

#### 关键代码
```java
// 获取运营商信息
TelephonyManager telephonyManager = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);
String operatorName = telephonyManager.getNetworkOperatorName();

// 获取信号强度
PhoneStateListener signalListener = new PhoneStateListener() {
    @Override
    public void onSignalStrengthsChanged(SignalStrength signalStrength) {
        super.onSignalStrengthsChanged(signalStrength);
        // 处理信号强度变化
    }
};
telephonyManager.listen(signalListener, PhoneStateListener.LISTEN_SIGNAL_STRENGTHS);

// 获取小区信息（Android 10+）
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
    List<CellInfo> cellInfos = telephonyManager.getAllCellInfo();
    for (CellInfo cellInfo : cellInfos) {
        if (cellInfo instanceof CellInfoGsm) {
            // 处理GSM小区信息
        } else if (cellInfo instanceof CellInfoLte) {
            // 处理LTE小区信息
        } else if (cellInfo instanceof CellInfoNr) {
            // 处理5G小区信息
        }
    }
}
```

### 2.2 拍照和信息叠加

#### 技术方案
- 使用`CameraX`库实现相机功能（推荐，支持现代Android版本）
- 或使用传统的`Camera` API（兼容旧版本）
- 在相机预览上叠加一个`TextView`或自定义`View`显示信号信息
- 拍照时，将信号信息绘制到照片上

#### 关键代码
```java
// 使用CameraX
val preview = Preview.Builder().build()
val imageCapture = ImageCapture.Builder()
    .setCaptureMode(ImageCapture.CAPTURE_MODE_MAXIMIZE_QUALITY)
    .build()

// 设置预览
preview.setSurfaceProvider(viewFinder.surfaceProvider)

// 拍照
val imageCaptureCallback = ImageCapture.OnImageCapturedCallback() {
    override fun onCaptureSuccess(image: ImageProxy) {
        // 处理拍摄的图像
        processImage(image)
    }
}

// 处理图像并叠加信息
private fun processImage(image: ImageProxy) {
    // 将ImageProxy转换为Bitmap
    val bitmap = image.toBitmap()
    
    // 创建新的Bitmap用于绘制
    val resultBitmap = bitmap.copy(Bitmap.Config.ARGB_8888, true)
    val canvas = Canvas(resultBitmap)
    
    // 绘制信号信息
    val paint = Paint()
    paint.color = Color.WHITE
    paint.textSize = 30f
    paint.style = Paint.Style.FILL
    
    // 绘制背景
    val backgroundPaint = Paint()
    backgroundPaint.color = Color.BLACK
    backgroundPaint.alpha = 128
    
    // 绘制信息
    val signalInfo = getCurrentSignalInfo()
    val text = "运营商: ${signalInfo.operator}\n" +
              "CGI: ${signalInfo.cgi}\n" +
              "频点: ${signalInfo.frequency}\n" +
              "频段: ${signalInfo.band}\n" +
              "电平: ${signalInfo.rssi}dBm"
    
    // 绘制在左下角
    canvas.drawRect(0f, resultBitmap.height - 200f, 400f, resultBitmap.height.toFloat(), backgroundPaint)
    canvas.drawText(text, 20f, resultBitmap.height - 160f, paint)
    
    // 保存图片
    saveImage(resultBitmap)
}
```

### 2.3 数据存储

#### 技术方案
- 使用SQLite数据库存储信号数据
- 使用文件系统存储照片
- 支持CSV格式导出数据

#### 关键代码
```java
// SQLite数据库帮助类
public class DatabaseHelper extends SQLiteOpenHelper {
    private static final String DATABASE_NAME = "signal_test.db";
    private static final int DATABASE_VERSION = 1;
    
    private static final String TABLE_SIGNAL = "signal_data";
    private static final String COLUMN_ID = "id";
    private static final String COLUMN_OPERATOR = "operator";
    private static final String COLUMN_CGI = "cgi";
    private static final String COLUMN_FREQUENCY = "frequency";
    private static final String COLUMN_BAND = "band";
    private static final String COLUMN_RSSI = "rssi";
    private static final String COLUMN_NETWORK_TYPE = "network_type";
    private static final String COLUMN_LATITUDE = "latitude";
    private static final String COLUMN_LONGITUDE = "longitude";
    private static final String COLUMN_LOCATION = "location";
    private static final String COLUMN_TIMESTAMP = "timestamp";
    private static final String COLUMN_PHOTO_PATH = "photo_path";
    
    // 创建表语句
    private static final String CREATE_TABLE = "CREATE TABLE " + TABLE_SIGNAL + " (" +
            COLUMN_ID + " INTEGER PRIMARY KEY AUTOINCREMENT, " +
            COLUMN_OPERATOR + " TEXT, " +
            COLUMN_CGI + " TEXT, " +
            COLUMN_FREQUENCY + " INTEGER, " +
            COLUMN_BAND + " TEXT, " +
            COLUMN_RSSI + " INTEGER, " +
            COLUMN_NETWORK_TYPE + " TEXT, " +
            COLUMN_LATITUDE + " REAL, " +
            COLUMN_LONGITUDE + " REAL, " +
            COLUMN_LOCATION + " TEXT, " +
            COLUMN_TIMESTAMP + " TEXT, " +
            COLUMN_PHOTO_PATH + " TEXT" +
            ");";
    
    // 构造方法
    public DatabaseHelper(Context context) {
        super(context, DATABASE_NAME, null, DATABASE_VERSION);
    }
    
    @Override
    public void onCreate(SQLiteDatabase db) {
        db.execSQL(CREATE_TABLE);
    }
    
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        db.execSQL("DROP TABLE IF EXISTS " + TABLE_SIGNAL);
        onCreate(db);
    }
    
    // 插入数据
    public long insertSignalData(SignalData data) {
        SQLiteDatabase db = this.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put(COLUMN_OPERATOR, data.getOperator());
        values.put(COLUMN_CGI, data.getCgi());
        values.put(COLUMN_FREQUENCY, data.getFrequency());
        values.put(COLUMN_BAND, data.getBand());
        values.put(COLUMN_RSSI, data.getRssi());
        values.put(COLUMN_NETWORK_TYPE, data.getNetworkType());
        values.put(COLUMN_LATITUDE, data.getLatitude());
        values.put(COLUMN_LONGITUDE, data.getLongitude());
        values.put(COLUMN_LOCATION, data.getLocation());
        values.put(COLUMN_TIMESTAMP, data.getTimestamp());
        values.put(COLUMN_PHOTO_PATH, data.getPhotoPath());
        
        long id = db.insert(TABLE_SIGNAL, null, values);
        db.close();
        return id;
    }
    
    // 获取所有数据
    public List<SignalData> getAllSignalData() {
        List<SignalData> dataList = new ArrayList<>();
        SQLiteDatabase db = this.getReadableDatabase();
        Cursor cursor = db.rawQuery("SELECT * FROM " + TABLE_SIGNAL + " ORDER BY " + COLUMN_TIMESTAMP + " DESC", null);
        
        if (cursor.moveToFirst()) {
            do {
                SignalData data = new SignalData();
                data.setId(cursor.getInt(cursor.getColumnIndex(COLUMN_ID)));
                data.setOperator(cursor.getString(cursor.getColumnIndex(COLUMN_OPERATOR)));
                // 设置其他字段...
                dataList.add(data);
            } while (cursor.moveToNext());
        }
        
        cursor.close();
        db.close();
        return dataList;
    }
}
```

## 2. 核心功能实现

### 2.1 信号信息采集

#### SignalCollector.java
```java
public class SignalCollector {
    private Context context;
    private TelephonyManager telephonyManager;
    
    public SignalCollector(Context context) {
        this.context = context;
        this.telephonyManager = (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE);
    }
    
    // 获取信号数据
    public SignalData getSignalData() {
        SignalData data = new SignalData();
        
        // 获取运营商信息
        data.setOperator(getOperator());
        
        // 获取网络类型
        data.setNetworkType(getNetworkType());
        
        // 获取小区信息
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            getCellInfoModern(data);
        } else {
            getCellInfoLegacy(data);
        }
        
        // 获取信号强度
        data.setRssi(getSignalStrength());
        
        return data;
    }
    
    // 获取运营商
    private String getOperator() {
        return telephonyManager.getNetworkOperatorName();
    }
    
    // 获取网络类型
    private String getNetworkType() {
        int type = telephonyManager.getNetworkType();
        switch (type) {
            case TelephonyManager.NETWORK_TYPE_GPRS:
            case TelephonyManager.NETWORK_TYPE_EDGE:
            case TelephonyManager.NETWORK_TYPE_CDMA:
            case TelephonyManager.NETWORK_TYPE_1xRTT:
            case TelephonyManager.NETWORK_TYPE_IDEN:
                return "2G";
            case TelephonyManager.NETWORK_TYPE_UMTS:
            case TelephonyManager.NETWORK_TYPE_EVDO_0:
            case TelephonyManager.NETWORK_TYPE_EVDO_A:
            case TelephonyManager.NETWORK_TYPE_HSDPA:
            case TelephonyManager.NETWORK_TYPE_HSUPA:
            case TelephonyManager.NETWORK_TYPE_HSPA:
            case TelephonyManager.NETWORK_TYPE_EVDO_B:
            case TelephonyManager.NETWORK_TYPE_EHRPD:
            case TelephonyManager.NETWORK_TYPE_HSPAP:
                return "3G";
            case TelephonyManager.NETWORK_TYPE_LTE:
                return "4G";
            case TelephonyManager.NETWORK_TYPE_NR:
                return "5G";
            default:
                return "Unknown";
        }
    }
    
    // 获取现代Android版本的小区信息
    @RequiresApi(api = Build.VERSION_CODES.Q)
    private void getCellInfoModern(SignalData data) {
        List<CellInfo> cellInfos = telephonyManager.getAllCellInfo();
        if (cellInfos != null && !cellInfos.isEmpty()) {
            for (CellInfo cellInfo : cellInfos) {
                if (cellInfo instanceof CellInfoLte) {
                    CellInfoLte cellInfoLte = (CellInfoLte) cellInfo;
                    CellIdentityLte identity = cellInfoLte.getCellIdentity();
                    
                    // 获取CGI
                    String cgi = "LTE:" + identity.getMcc() + "-" + identity.getMnc() + "-" + 
                                identity.getTac() + "-" + identity.getCi();
                    data.setCgi(cgi);
                    
                    // 获取频点
                    data.setFrequency(identity.getEarfcn());
                    
                    // 获取频段
                    data.setBand(getBandFromEarfcn(identity.getEarfcn()));
                    
                    break;
                }
                // 处理其他网络类型...
            }
        }
    }
    
    // 获取传统Android版本的小区信息
    private void getCellInfoLegacy(SignalData data) {
        // 使用反射获取信息
        try {
            // 反射代码...
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // 获取信号强度
    private int getSignalStrength() {
        // 使用PhoneStateListener或反射获取
        // 实现细节...
        return 0;
    }
    
    // 根据频点获取频段
    private String getBandFromEarfcn(int earfcn) {
        // 频段映射表
        // 实现细节...
        return "Unknown";
    }
}
```

### 2.2 权限管理

#### 权限申请
```java
// 在MainActivity中申请权限
private static final int REQUEST_PERMISSIONS = 100;

private void requestPermissions() {
    String[] permissions = {
        Manifest.permission.ACCESS_FINE_LOCATION,
        Manifest.permission.CAMERA,
        Manifest.permission.WRITE_EXTERNAL_STORAGE,
        Manifest.permission.READ_PHONE_STATE
    };
    
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        requestPermissions(permissions, REQUEST_PERMISSIONS);
    }
}

@Override
public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
    super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    if (requestCode == REQUEST_PERMISSIONS) {
        boolean allGranted = true;
        for (int result : grantResults) {
            if (result != PackageManager.PERMISSION_GRANTED) {
                allGranted = false;
                break;
            }
        }
        
        if (allGranted) {
            // 权限全部授予，初始化服务
            initServices();
        } else {
            // 权限被拒绝，显示提示
            Toast.makeText(this, "需要权限才能正常使用", Toast.LENGTH_SHORT).show();
        }
    }
}
```

## 3. 界面实现

### 3.1 主界面 (activity_main.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@color/white">

    <!-- 顶部网络类型和信号强度 -->
    <LinearLayout
        android:id="@+id/top_bar"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:padding="16dp"
        android:background="@color/primary">

        <TextView
            android:id="@+id/network_type"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="4G"
            android:textColor="@color/white"
            android:textSize="18sp"
            android:fontWeight="bold"/>

        <TextView
            android:id="@+id/signal_strength"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="-75 dBm"
            android:textColor="@color/white"
            android:textSize="18sp"
            android:layout_marginLeft="16dp"/>
    </LinearLayout>

    <!-- 信号信息显示区域 -->
    <FrameLayout
        android:id="@+id/signal_info_container"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@id/top_bar"
        android:padding="16dp">

        <!-- 信号信息Fragment将被加载到这里 -->
    </FrameLayout>

    <!-- 底部拍照按钮 -->
    <Button
        android:id="@+id/btn_camera"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_alignParentBottom="true"
        android:text="拍照记录"
        android:background="@color/primary"
        android:textColor="@color/white"
        android:textSize="18sp"
        android:padding="16dp"/>

    <!-- 历史记录按钮 -->
    <Button
        android:id="@+id/btn_history"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_above="@id/btn_camera"
        android:layout_alignParentRight="true"
        android:text="历史记录"
        android:background="@color/secondary"
        android:textColor="@color/white"
        android:layout_margin="16dp"/>

</RelativeLayout>
```

### 3.2 相机界面 (activity_camera.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <!-- 相机预览 -->
    <TextureView
        android:id="@+id/view_finder"
        android:layout_width="match_parent"
        android:layout_height="match_parent"/>

    <!-- 信号信息叠加层 -->
    <LinearLayout
        android:id="@+id/signal_info_overlay"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_alignParentBottom="true"
        android:layout_alignParentLeft="true"
        android:orientation="vertical"
        android:background="@color/overlay_background"
        android:padding="8dp">

        <TextView
            android:id="@+id/overlay_operator"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textColor="@color/white"
            android:textSize="12sp"/>

        <TextView
            android:id="@+id/overlay_cgi"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textColor="@color/white"
            android:textSize="12sp"/>

        <TextView
            android:id="@+id/overlay_frequency"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textColor="@color/white"
            android:textSize="12sp"/>

        <TextView
            android:id="@+id/overlay_band"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textColor="@color/white"
            android:textSize="12sp"/>

        <TextView
            android:id="@+id/overlay_rssi"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textColor="@color/white"
            android:textSize="12sp"/>
    </LinearLayout>

    <!-- 拍照按钮 -->
    <Button
        android:id="@+id/btn_capture"
        android:layout_width="80dp"
        android:layout_height="80dp"
        android:layout_centerHorizontal="true"
        android:layout_alignParentBottom="true"
        android:layout_marginBottom="32dp"
        android:background="@drawable/capture_button"
        android:elevation="8dp"/>

    <!-- 返回按钮 -->
    <Button
        android:id="@+id/btn_back"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_alignParentTop="true"
        android:layout_alignParentLeft="true"
        android:layout_margin="16dp"
        android:text="返回"
        android:background="@color/transparent"
        android:textColor="@color/white"/>

    <!-- 相册按钮 -->
    <Button
        android:id="@+id/btn_gallery"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_alignParentTop="true"
        android:layout_alignParentRight="true"
        android:layout_margin="16dp"
        android:text="相册"
        android:background="@color/transparent"
        android:textColor="@color/white"/>

</RelativeLayout>
```

## 4. 开发步骤

### 4.1 初始化项目
1. 在Android Studio中创建新项目
2. 配置项目依赖（CameraX、SQLite等）
3. 设置权限清单

### 4.2 核心功能开发
1. 实现信号信息采集功能
2. 实现相机和拍照功能
3. 实现数据存储功能

### 4.3 UI开发
1. 实现主界面
2. 实现相机界面
3. 实现历史记录界面

### 4.4 测试与调试
1. 在不同设备上测试
2. 测试不同网络环境
3. 优化性能和用户体验

## 5. 技术难点及解决方案

### 5.1 信号信息获取

#### 难点
- 不同Android版本的API差异
- 不同网络类型（2G/3G/4G/5G）的信息获取方式不同
- 部分信息需要特殊权限

#### 解决方案
- 使用反射机制兼容不同版本的API
- 针对不同网络类型分别实现信息获取逻辑
- 合理申请权限并提供用户引导

### 5.2 照片信息叠加

#### 难点
- 实时在相机预览上显示信号信息
- 确保信息在照片上正确显示
- 处理不同屏幕尺寸和分辨率

#### 解决方案
- 使用叠加层View在预览上显示信息
- 拍照后使用Canvas绘制信息到照片
- 适配不同屏幕尺寸的布局

### 5.3 权限管理

#### 难点
- Android 6.0+的动态权限申请
- 部分权限（如READ_PHONE_STATE）在高版本Android上限制严格

#### 解决方案
- 按照最佳实践实现动态权限申请
- 对于受限权限，提供替代方案或用户引导
- 适配Android 10+的存储权限变更

## 6. 性能优化

### 6.1 内存优化
- 使用ViewHolder模式优化列表显示
- 及时释放Bitmap资源
- 使用内存缓存减少重复计算

### 6.2 电池优化
- 合理使用后台服务
- 减少不必要的网络请求和定位更新
- 使用JobScheduler或WorkManager处理后台任务

### 6.3 响应速度优化
- 使用异步线程处理耗时操作
- 优化数据库查询
- 使用缓存减少重复计算

## 7. 兼容性考虑

### 7.1 Android版本兼容
- 最低支持Android 6.0 (API 23)
- 针对不同API级别提供兼容实现
- 使用AndroidX库提高兼容性

### 7.2 设备兼容
- 测试不同屏幕尺寸和分辨率
- 适配不同相机硬件
- 处理不同网络环境

## 8. 总结

本技术方案提供了一个完整的安卓信号测试软件实现框架，包括项目结构、核心功能实现、界面设计和开发步骤。通过合理的技术选型和实现方案，可以开发出一款功能完备、性能优良的信号测试工具，满足用户对信号小区信息采集和拍照记录的需求。

项目采用模块化设计，便于后续扩展和维护。同时，通过兼容性处理和性能优化，可以确保软件在不同设备和网络环境下的稳定运行。